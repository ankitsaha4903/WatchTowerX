{% extends "base.html" %}

{% block content %}
<div class="grid-3">
    <div class="glass-panel text-center">
        <h3 class="text-muted">Total Devices</h3>
        <h1 class="display-4 text-accent" id="devices-count">{{ devices_count }}</h1>
    </div>
    <div class="glass-panel text-center">
        <h3 class="text-muted">Total Logs</h3>
        <h1 class="display-4 text-accent" id="logs-count">{{ logs_count }}</h1>
    </div>
    <div class="glass-panel text-center">
        <h3 class="text-muted">System Status</h3>
        <h1 class="display-4 text-success"><i class="fas fa-check-circle"></i> Active</h1>
    </div>
</div>

<div class="grid-2">
    <div class="glass-panel">
        <h3><i class="fas fa-chart-pie"></i> Activity Overview</h3>
        <canvas id="activityChart"></canvas>
    </div>
    <div class="glass-panel">
        <h3><i class="fas fa-history"></i> Recent Activity</h3>
        <div class="table-responsive">
            <table class="table table-sm text-light" id="logs-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Event</th>
                        <th>Message</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs %}
                    <tr>
                        <td class="text-muted small">{{ log['timestamp'].split('T')[1][:8] }}</td>
                        <td>
                            {% if log['level'] == 'CRITICAL' %}
                            <span class="badge badge-danger">{{ log['event_type'] }}</span>
                            {% elif log['level'] == 'WARN' %}
                            <span class="badge badge-warning">{{ log['event_type'] }}</span>
                            {% else %}
                            <span class="badge badge-success">{{ log['event_type'] }}</span>
                            {% endif %}
                        </td>
                        <td class="small">{{ log['message'] }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="text-right mt-3">
            <a href="{{ url_for('logs') }}" class="btn btn-sm btn-primary">View All Logs</a>
        </div>
    </div>
</div>

<script>
    // Simple Chart.js setup
    const ctx = document.getElementById('activityChart').getContext('2d');
    const activityChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Allowed', 'Blocked', 'DLP Violations'],
            datasets: [{
                data: [12, 5, 2], // Placeholder data - ideally fetch from API
                backgroundColor: [
                    'rgba(0, 255, 157, 0.6)',  // Neon Green (Success)
                    'rgba(188, 19, 254, 0.6)', // Neon Purple (Accent)
                    'rgba(255, 42, 109, 0.6)'  // Neon Red (Danger)
                ],
                borderColor: [
                    '#00ff9d',
                    '#bc13fe',
                    '#ff2a6d'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#00ff9d',
                        font: {
                            family: "'Orbitron', sans-serif"
                        }
                    }
                }
            }
        }
    });

    // Real-time updates (poll every 5 seconds)
    setInterval(() => {
        fetch('/api/overview')
            .then(response => response.json())
            .then(data => {
                document.getElementById('devices-count').innerText = data.devices_count;
                document.getElementById('logs-count').innerText = data.logs_count;

                // Update table
                const tbody = document.querySelector('#logs-table tbody');
                tbody.innerHTML = '';
                data.logs.forEach(log => {
                    let badgeClass = 'badge-success';
                    if (log.level === 'CRITICAL') badgeClass = 'badge-danger';
                    else if (log.level === 'WARN') badgeClass = 'badge-warning';

                    const time = log.timestamp.split('T')[1].substring(0, 8);

                    const row = `
                <tr>
                    <td class="text-muted small">${time}</td>
                    <td><span class="badge ${badgeClass}">${log.event_type}</span></td>
                    <td class="small">${log.message}</td>
                </tr>
            `;
                    tbody.innerHTML += row;
                });
            });
    }, 5000);
</script>
{% endblock %}