{% extends "base.html" %}
{% block content %}
<div class="glass-panel" style="height: 80vh; display: flex; flex-direction: column;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h2><i class="fas fa-terminal"></i> Live Threat Monitor</h2>
        <div>
            <span class="badge badge-success" id="status-badge">CONNECTED</span>
        </div>
    </div>

    <div id="terminal" style="
        flex: 1;
        background: rgba(0, 0, 0, 0.8);
        border: 1px solid var(--accent-cyan);
        padding: 15px;
        font-family: 'Courier New', Courier, monospace;
        overflow-y: auto;
        color: #00ff00;
        font-size: 0.9rem;
        box-shadow: inset 0 0 20px rgba(0, 243, 255, 0.1);
    ">
        <div class="log-line text-muted">Initializing connection to USB Guard Agent...</div>
    </div>
</div>

<script>
    const terminal = document.getElementById('terminal');
    const statusBadge = document.getElementById('status-badge');

    function appendLog(data) {
        const line = document.createElement('div');
        line.style.marginBottom = '4px';
        line.style.borderBottom = '1px solid rgba(255,255,255,0.05)';

        // Timestamp - Convert UTC to Local Time
        const ts = document.createElement('span');
        const localTime = new Date(data.timestamp + "Z").toLocaleTimeString();
        ts.innerText = `[${localTime}] `;
        ts.style.color = '#888';
        line.appendChild(ts);

        // Level/Type
        const type = document.createElement('span');
        type.innerText = `[${data.event_type.toUpperCase()}] `;

        if (data.level === 'CRITICAL') {
            type.style.color = '#ff2a6d'; // Red
            line.style.backgroundColor = 'rgba(255, 42, 109, 0.1)';
        } else if (data.level === 'WARN') {
            type.style.color = '#fcee0a'; // Yellow
        } else if (data.event_type === 'scan_safe') {
            type.style.color = '#00ff9d'; // Green
        } else if (data.event_type === 'scan_start') {
            type.style.color = '#00f3ff'; // Cyan
        } else {
            type.style.color = '#ccc';
        }
        line.appendChild(type);

        // Message
        const msg = document.createElement('span');
        msg.innerText = data.message;
        msg.style.color = '#fff';
        line.appendChild(msg);

        terminal.appendChild(line);
        terminal.scrollTop = terminal.scrollHeight;

        // Limit lines to prevent memory leak
        if (terminal.children.length > 500) {
            terminal.removeChild(terminal.firstChild);
        }
    }

    const eventSource = new EventSource("{{ url_for('stream') }}");

    eventSource.onmessage = function (e) {
        const data = JSON.parse(e.data);
        appendLog(data);
    };

    eventSource.onerror = function (e) {
        statusBadge.innerText = "DISCONNECTED";
        statusBadge.className = "badge badge-danger";
        appendLog({
            timestamp: new Date().toISOString(),
            level: 'ERROR',
            event_type: 'connection_error',
            message: 'Lost connection to server. Retrying...'
        });
    };

    eventSource.onopen = function (e) {
        statusBadge.innerText = "LIVE";
        statusBadge.className = "badge badge-success";
    };

</script>
{% endblock %}